<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Price List Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to match original */
        .gradient-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 50%, #2563eb 100%);
        }
        
        .product-card {
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .preview-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .price-badge {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        }
        
        .shopify-connected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .shopify-disconnected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto p-4 lg:p-8 max-w-7xl">
        <!-- Main Header Card -->
        <div class="bg-white rounded-xl shadow-xl mb-8">
            <div class="p-6 lg:p-8 border-b border-gray-200">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div>
                        <h1 class="text-2xl lg:text-4xl font-bold text-gray-900 mb-3">Shopify Price List Generator</h1>
                        <p class="text-gray-600 text-base lg:text-lg">Connect your Shopify store and create professional price lists</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="connectionStatus" class="flex items-center gap-2 px-4 py-2 shopify-disconnected text-white rounded-lg">
                            <span>‚ùå</span>
                            <span class="font-medium">Not Connected</span>
                        </div>
                        <button id="shopifyPanelBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            üõçÔ∏è Shopify
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shopify Connection Panel -->
            <div id="shopifyPanel" class="p-6 lg:p-8 bg-blue-50 border-b border-blue-200 hidden">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Shopify Connection</h3>
                
                <!-- Connection Form -->
                <div id="connectionForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Store Name</label>
                            <input id="storeName" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="your-store-name">
                            <p class="text-xs text-gray-500 mt-1">Just the store name, not the full URL</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Admin API Access Token</label>
                            <input id="accessToken" type="password" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="shpat_...">
                            <p class="text-xs text-gray-500 mt-1">Get from Shopify Admin ‚Üí Settings ‚Üí Apps and sales channels ‚Üí Develop apps</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button id="connectBtn" class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <span id="connectIcon">üõçÔ∏è</span>
                            <span id="connectText">Connect to Shopify</span>
                        </button>
                        <button id="cancelBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                    </div>
                    
                    <!-- Setup Instructions -->
                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start gap-2">
                            <span class="text-yellow-600">‚ö†Ô∏è</span>
                            <div class="text-sm text-yellow-800">
                                <p class="font-semibold mb-2">Setup Instructions</p>
                                <ol class="list-decimal list-inside space-y-1 text-xs">
                                    <li>Go to your Shopify Admin ‚Üí Settings ‚Üí Apps and sales channels</li>
                                    <li>Click "Develop apps" ‚Üí "Create an app"</li>
                                    <li>Name it "Price List Generator"</li>
                                    <li>Click "Configure Admin API scopes"</li>
                                    <li>Enable: <strong>read_products</strong> and <strong>read_collections</strong></li>
                                    <li>Save, then click "Install app"</li>
                                    <li>Copy the "Admin API access token" (starts with shpat_)</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Connected State -->
                <div id="connectedState" class="hidden space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Connected to <strong id="connectedStore"></strong></p>
                            <p class="text-xs text-gray-500">
                                <span id="productCount">0</span> products ‚Ä¢ <span id="collectionCount">0</span> collections
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button id="refreshBtn" class="flex items-center gap-1 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <span id="refreshIcon">üîÑ</span> Refresh
                            </button>
                            <button id="disconnectBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                Disconnect
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="text-2xl font-bold text-blue-600" id="statsProducts">0</div>
                            <div class="text-sm text-gray-600">Products</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="text-2xl font-bold text-green-600" id="statsCollections">0</div>
                            <div class="text-sm text-gray-600">Collections</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="text-2xl font-bold text-purple-600" id="statsTypes">0</div>
                            <div class="text-sm text-gray-600">Product Types</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="text-2xl font-bold text-orange-600" id="statsVendors">0</div>
                            <div class="text-sm text-gray-600">Vendors</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shopify Product Selection -->
            <div id="productSelection" class="p-6 lg:p-8 border-b border-gray-200 hidden">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Select Products from Shopify</h3>
                
                <!-- Filter Controls -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filter Mode</label>
                        <select id="filterMode" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Products</option>
                            <option value="collection">By Collection</option>
                            <option value="type">By Product Type</option>
                            <option value="vendor">By Vendor</option>
                            <option value="custom">Custom Filter</option>
                        </select>
                    </div>

                    <div id="collectionFilter" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Collection</label>
                        <select id="selectedCollection" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Collection</option>
                        </select>
                    </div>

                    <div id="typeFilter" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Product Type</label>
                        <select id="selectedType" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Type</option>
                        </select>
                    </div>

                    <div id="vendorFilter" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Vendor</label>
                        <select id="selectedVendor" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Vendor</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Search Products</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                            <input id="productSearch" type="text" placeholder="Search by name, type, vendor..." class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Custom Filters -->
                <div id="customFilters" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Price Range</label>
                        <div class="flex gap-2">
                            <input id="priceMin" type="number" placeholder="Min" class="flex-1 p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input id="priceMax" type="number" placeholder="Max" class="flex-1 p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Quick Collection Actions -->
                <div id="quickActions" class="flex flex-wrap gap-2 mb-6">
                    <span class="text-sm font-semibold text-gray-700">Quick Actions:</span>
                </div>

                <!-- Selection Controls -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-semibold text-gray-700">
                            <span id="selectedCount">0</span> selected
                        </span>
                        <button id="addSelectedBtn" class="hidden flex items-center gap-1 px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            ‚ûï Add to Price List
                        </button>
                    </div>
                    
                    <button id="selectAllBtn" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition-colors text-sm">
                        Select All Filtered (<span id="filteredCount">0</span>)
                    </button>
                    
                    <button id="clearSelectionBtn" class="px-3 py-1 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        Clear Selection
                    </button>
                </div>

                <!-- Product Grid -->
                <div id="shopifyProductGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <div class="text-6xl mb-4">üì¶</div>
                        <p>Connect to Shopify to browse your products</p>
                    </div>
                </div>
            </div>

            <!-- Company Information Section -->
            <div class="p-6 lg:p-8">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Company Information</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Company Name</label>
                        <input id="companyName" type="text" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-lg" placeholder="Your Company Name" value="Your Company Name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Company Logo</label>
                        <div class="flex gap-4 items-center">
                            <div id="logoPreview" class="w-24 h-24 bg-gray-100 rounded-lg border-2 border-gray-300 flex items-center justify-center overflow-hidden">
                                <div class="text-gray-400 text-center">
                                    <div class="text-2xl mb-1">üè¢</div>
                                    <div class="text-xs">No Logo</div>
                                </div>
                            </div>
                            <input id="logoInput" type="file" accept="image/*" class="hidden">
                            <button id="logoUploadBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                Upload Logo
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Phone Number</label>
                        <input id="companyPhone" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="+27 11 123 4567" value="+1 234-567-8900">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Email Address</label>
                        <input id="companyEmail" type="email" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="sales@yourcompany.com" value="sales@yourcompany.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Website</label>
                        <input id="companyWebsite" type="url" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="https://yourcompany.com" value="https://yourcompany.com">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Company Tagline</label>
                        <input id="companyTagline" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Your Company Tagline" value="Your Company Tagline">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Terms & Conditions</label>
                        <input id="companyTerms" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Payment terms: Net 30. T&C's Apply." value="Payment terms: Net 30. Terms & Conditions Apply.">
                    </div>
                </div>

                <!-- List Title and Bullet Points -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8 mb-8">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">List Title</label>
                        <input id="listTitle" type="text" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-lg" placeholder="PRODUCT CATALOG" value="PRODUCT CATALOG">
                    </div>
                    
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Title Block Bullet Points</h3>
                        <div class="space-y-2">
                            <input id="bulletPoint1" type="text" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Professional Grade" value="Professional Grade">
                            <input id="bulletPoint2" type="text" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Quality Assured" value="Quality Assured">
                            <input id="bulletPoint3" type="text" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Fast Delivery" value="Fast Delivery">
                        </div>
                    </div>
                </div>

                <!-- Product Management -->
                <div class="mb-8">
                    <div class="flex flex-col gap-4 mb-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h3 class="text-xl lg:text-2xl font-bold text-gray-900">
                                Price List Products (<span id="priceListProductCount">0</span>)
                            </h3>
                            
                            <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                                <button id="previewBtn" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium">
                                    <span id="previewIcon">üëÅÔ∏è</span>
                                    <span id="previewText">Show Preview</span>
                                </button>
                                
                                <button id="addManualBtn" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                    ‚ûï Add Manual Product
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search */}
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative flex-1">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                                <input id="priceListSearch" type="text" placeholder="Search price list products..." class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            </div>
                            
                            <div class="flex gap-2">
                                <button id="viewModeGrid" class="p-3 rounded-lg transition-colors bg-blue-600 text-white">
                                    ‚äû
                                </button>
                                <button id="viewModeList" class="p-3 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                                    ‚ò∞
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Product List/Grid -->
                    <div id="priceListProducts" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Products will be inserted here -->
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-16 bg-gray-50 rounded-xl">
                        <div class="text-6xl mb-4">‚ö°</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No products yet!</h3>
                        <p class="text-gray-500 mb-6" id="emptyStateText">
                            Connect to Shopify to import products, or add products manually.
                        </p>
                        <div class="flex gap-4 justify-center">
                            <button id="emptyConnectBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                Connect to Shopify
                            </button>
                            <button id="emptyManualBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                                Add Manual Product
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div id="exportSection" class="text-center mt-8 hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h4 class="font-semibold text-blue-900 mb-2">Export Instructions</h4>
                        <p class="text-blue-800 text-sm">
                            ‚Ä¢ Click "Export Price List" to open a new window with only your price list<br/>
                            ‚Ä¢ The new window will automatically trigger the print dialog<br/>
                            ‚Ä¢ Choose "Save as PDF" from the print destination<br/>
                            ‚Ä¢ Products with URLs will be clickable when viewed digitally<br/>
                            ‚Ä¢ For best results, use A4 paper size and check "More settings" ‚Üí "Background graphics"
                        </p>
                    </div>
                    <button id="exportBtn" class="flex items-center gap-3 px-8 py-4 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors font-semibold text-lg shadow-lg hover:shadow-xl mx-auto">
                        üì• Export Price List to PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="bg-white rounded-xl shadow-xl hidden">
            <div class="p-6 lg:p-8 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-gray-900">Preview</h3>
            </div>
            <div id="previewContent">
                <!-- Preview will be generated here -->
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                <span id="loadingText" class="text-gray-900">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const state = {
            shopifyConnected: false,
            shopifyStore: '',
            shopifyToken: '',
            shopifyProducts: [],
            shopifyCollections: [],
            productTypes: [],
            vendors: [],
            selectedProducts: [],
            products: [],
            filterMode: 'all',
            viewMode: 'grid',
            showPreview: false,
            companyLogo: null
        };

        // DOM Elements
        const elements = {
            // Shopify Panel
            shopifyPanelBtn: document.getElementById('shopifyPanelBtn'),
            shopifyPanel: document.getElementById('shopifyPanel'),
            connectionForm: document.getElementById('connectionForm'),
            connectedState: document.getElementById('connectedState'),
            storeName: document.getElementById('storeName'),
            accessToken: document.getElementById('accessToken'),
            connectBtn: document.getElementById('connectBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            
            // Status indicators
            connectionStatus: document.getElementById('connectionStatus'),
            productSelection: document.getElementById('productSelection'),
            
            // Filter controls
            filterMode: document.getElementById('filterMode'),
            collectionFilter: document.getElementById('collectionFilter'),
            typeFilter: document.getElementById('typeFilter'),
            vendorFilter: document.getElementById('vendorFilter'),
            customFilters: document.getElementById('customFilters'),
            productSearch: document.getElementById('productSearch'),
            
            // Product grid
            shopifyProductGrid: document.getElementById('shopifyProductGrid'),
            selectedCount: document.getElementById('selectedCount'),
            addSelectedBtn: document.getElementById('addSelectedBtn'),
            selectAllBtn: document.getElementById('selectAllBtn'),
            clearSelectionBtn: document.getElementById('clearSelectionBtn'),
            
            // Price list management
            priceListProducts: document.getElementById('priceListProducts'),
            priceListProductCount: document.getElementById('priceListProductCount'),
            emptyState: document.getElementById('emptyState'),
            exportSection: document.getElementById('exportSection'),
            
            // Company info
            companyName: document.getElementById('companyName'),
            logoInput: document.getElementById('logoInput'),
            logoUploadBtn: document.getElementById('logoUploadBtn'),
            logoPreview: document.getElementById('logoPreview'),
            
            // Preview
            previewBtn: document.getElementById('previewBtn'),
            previewSection: document.getElementById('previewSection'),
            
            // Loading
            loadingModal: document.getElementById('loadingModal'),
            loadingText: document.getElementById('loadingText')
        };

        // Real Shopify API Integration
        const shopifyAPI = {
            async fetchProducts(store, token, limit = 250) {
                const url = `https://${store}.myshopify.com/admin/api/2024-01/products.json?limit=${limit}`;
                const response = await fetch(url, {
                    headers: {
                        'X-Shopify-Access-Token': token,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to fetch products: ${response.status} ${response.statusText}. ${errorData}`);
                }

                const data = await response.json();
                return data.products || [];
            },

            async fetchCollections(store, token) {
                const url = `https://${store}.myshopify.com/admin/api/2024-01/collections.json`;
                const response = await fetch(url, {
                    headers: {
                        'X-Shopify-Access-Token': token,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to fetch collections: ${response.status} ${response.statusText}. ${errorData}`);
                }

                const data = await response.json();
                return data.collections || [];
            },

            async testConnection(store, token) {
                const url = `https://${store}.myshopify.com/admin/api/2024-01/shop.json`;
                const response = await fetch(url, {
                    headers: {
                        'X-Shopify-Access-Token': token,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Connection failed: ${response.status} ${response.statusText}. ${errorData}`);
                }

                return await response.json();
            }
        };

        // Utility Functions
        function showLoading(text = 'Loading...') {
            elements.loadingText.textContent = text;
            elements.loadingModal.classList.remove('hidden');
            elements.loadingModal.classList.add('flex');
        }

        function hideLoading() {
            elements.loadingModal.classList.add('hidden');
            elements.loadingModal.classList.remove('flex');
        }

        function updateConnectionStatus(connected, store = '') {
            if (connected) {
                elements.connectionStatus.innerHTML = `
                    <span>‚úÖ</span>
                    <span class="font-medium">Connected to ${store}</span>
                `;
                elements.connectionStatus.className = 'flex items-center gap-2 px-4 py-2 shopify-connected text-white rounded-lg';
                elements.productSelection.classList.remove('hidden');
            } else {
                elements.connectionStatus.innerHTML = `
                    <span>‚ùå</span>
                    <span class="font-medium">Not Connected</span>
                `;
                elements.connectionStatus.className = 'flex items-center gap-2 px-4 py-2 shopify-disconnected text-white rounded-lg';
                elements.productSelection.classList.add('hidden');
            }
        }

        function updateStats(products, collections, types, vendors) {
            document.getElementById('productCount').textContent = products.length;
            document.getElementById('collectionCount').textContent = collections.length;
            document.getElementById('statsProducts').textContent = products.length;
            document.getElementById('statsCollections').textContent = collections.length;
            document.getElementById('statsTypes').textContent = types.length;
            document.getElementById('statsVendors').textContent = vendors.length;
        }

        function populateFilters(collections, types, vendors) {
            // Collections
            const collectionSelect = document.getElementById('selectedCollection');
            collectionSelect.innerHTML = '<option value="">Select Collection</option>';
            collections.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection.id;
                option.textContent = collection.title;
                collectionSelect.appendChild(option);
            });

            // Product Types
            const typeSelect = document.getElementById('selectedType');
            typeSelect.innerHTML = '<option value="">Select Type</option>';
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });

            // Vendors
            const vendorSelect = document.getElementById('selectedVendor');
            vendorSelect.innerHTML = '<option value="">Select Vendor</option>';
            vendors.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor;
                option.textContent = vendor;
                vendorSelect.appendChild(option);
            });
        }

        function createShopifyProductCard(product) {
            const isSelected = state.selectedProducts.includes(product.id.toString());
            const price = parseFloat(product.variants[0]?.price || 0);
            const formattedPrice = `R ${price.toFixed(2)}`;

            return `
                <div class="p-4 border-2 rounded-lg cursor-pointer transition-all ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}" 
                     onclick="toggleProductSelection(${product.id})">
                    <div class="flex items-start gap-3">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0">
                            ${product.images && product.images[0] ? `
                                <img src="${product.images[0].src}" alt="${product.title}" class="w-full h-full object-cover">
                            ` : `
                                <span class="text-gray-400">üì¶</span>
                            `}
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-gray-900 truncate">${product.title}</h4>
                            <p class="text-sm text-gray-600">${product.product_type || 'No type'}</p>
                            <p class="text-sm text-gray-500">${product.vendor || 'No vendor'}</p>
                            <div class="flex items-center justify-between mt-2">
                                <span class="font-bold text-green-600">${formattedPrice}</span>
                                <span class="text-xs text-gray-500">${product.variants.length} variant${product.variants.length !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        
                        ${isSelected ? `
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center">‚úì</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderShopifyProducts(products) {
            if (!products || products.length === 0) {
                elements.shopifyProductGrid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <div class="text-6xl mb-4">üì≠</div>
                        <p>No products found</p>
                        <p class="text-sm text-gray-400">Try adjusting your search or collection filter</p>
                    </div>
                `;
                return;
            }

            elements.shopifyProductGrid.innerHTML = products.map(createShopifyProductCard).join('');
            updateSelectionUI();
        }

        function updateSelectionUI() {
            elements.selectedCount.textContent = state.selectedProducts.length;
            
            if (state.selectedProducts.length > 0) {
                elements.addSelectedBtn.classList.remove('hidden');
            } else {
                elements.addSelectedBtn.classList.add('hidden');
            }
        }

        function getFilteredProducts() {
            let filtered = [...state.shopifyProducts];

            // Apply search
            const searchQuery = elements.productSearch.value.toLowerCase();
            if (searchQuery) {
                filtered = filtered.filter(product =>
                    product.title.toLowerCase().includes(searchQuery) ||
                    product.product_type?.toLowerCase().includes(searchQuery) ||
                    product.vendor?.toLowerCase().includes(searchQuery)
                );
            }

            // Apply filter mode
            const filterMode = elements.filterMode.value;
            switch (filterMode) {
                case 'collection':
                    const selectedCollection = document.getElementById('selectedCollection').value;
                    if (selectedCollection) {
                        // Note: This is simplified - real implementation would need collection product mapping
                        filtered = filtered.filter(product => 
                            product.collection_ids?.includes(parseInt(selectedCollection))
                        );
                    }
                    break;
                case 'type':
                    const selectedType = document.getElementById('selectedType').value;
                    if (selectedType) {
                        filtered = filtered.filter(product => product.product_type === selectedType);
                    }
                    break;
                case 'vendor':
                    const selectedVendor = document.getElementById('selectedVendor').value;
                    if (selectedVendor) {
                        filtered = filtered.filter(product => product.vendor === selectedVendor);
                    }
                    break;
                case 'custom':
                    const minPrice = parseFloat(document.getElementById('priceMin').value || 0);
                    const maxPrice = parseFloat(document.getElementById('priceMax').value || Infinity);
                    filtered = filtered.filter(product => {
                        const price = parseFloat(product.variants[0]?.price || 0);
                        return price >= minPrice && price <= maxPrice;
                    });
                    break;
            }

            return filtered;
        }

        function convertShopifyProduct(shopifyProduct, variantIndex = 0) {
            const variant = shopifyProduct.variants[variantIndex] || shopifyProduct.variants[0];
            
            return {
                id: `shopify_${shopifyProduct.id}_${variant.id}`,
                model: `${shopifyProduct.title}${shopifyProduct.variants.length > 1 ? ` - ${variant.title}` : ''}`,
                image: shopifyProduct.images[0]?.src || null,
                specs: {
                    sku: variant.sku || '',
                    type: shopifyProduct.product_type || '',
                    vendor: shopifyProduct.vendor || '',
                    stock: variant.inventory_quantity || 0,
                    weight: variant.weight ? `${variant.weight} ${variant.weight_unit}` : '',
                    description: shopifyProduct.body_html ? shopifyProduct.body_html.replace(/<[^>]*>/g, '').substring(0, 100) : ''
                },
                price: `R ${parseFloat(variant.price || 0).toFixed(2)}`,
                comparePrice: variant.compare_at_price ? `R ${parseFloat(variant.compare_at_price).toFixed(2)}` : '',
                incVat: 'INCL VAT',
                productUrl: `https://${state.shopifyStore}.myshopify.com/products/${shopifyProduct.handle}`,
                shopifyData: {
                    productId: shopifyProduct.id,
                    variantId: variant.id,
                    handle: shopifyProduct.handle,
                    status: shopifyProduct.status
                }
            };
        }

        function createPriceListProductCard(product, index) {
            return `
                <div class="border-2 border-gray-200 rounded-xl p-6 bg-gray-50 product-card">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="text-xl font-bold text-gray-900">${product.model || `Product ${index + 1}`}</h4>
                        <div class="flex gap-2">
                            <button onclick="duplicateProduct('${product.id}')" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors" title="Duplicate">üìã</button>
                            <button onclick="removeProduct('${product.id}')" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product Image</label>
                            <div class="w-full h-24 bg-white rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden">
                                ${product.image ? `
                                    <img src="${product.image}" alt="Product preview" class="w-full h-full object-cover">
                                ` : `
                                    <span class="text-gray-400 text-sm">No image</span>
                                `}
                            </div>
                            ${!product.shopifyData ? `
                                <input type="file" accept="image/*" onchange="updateProductImage('${product.id}', this)" class="w-full text-xs mt-2">
                            ` : ''}
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Model/Name</label>
                            <input type="text" value="${product.model}" onchange="updateProduct('${product.id}', 'model', this.value)" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter model name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Price</label>
                            <input type="text" value="${product.price}" onchange="updateProduct('${product.id}', 'price', this.value)" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="R 1,000.00">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product URL</label>
                            <input type="url" value="${product.productUrl}" onchange="updateProduct('${product.id}', 'productUrl', this.value)" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com/product" ${product.shopifyData ? 'readonly' : ''}>
                        </div>
                        
                        ${Object.entries(product.specs).map(([key, value]) => `
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">${key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1')}</label>
                                <input type="text" value="${value || ''}" onchange="updateProductSpec('${product.id}', '${key}', this.value)" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter ${key.toLowerCase()}" ${product.shopifyData && key !== 'description' ? 'readonly' : ''}>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${product.shopifyData ? `
                        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-center gap-2 text-green-800">
                                <span>üõçÔ∏è</span>
                                <span class="text-sm font-medium">Imported from Shopify</span>
                            </div>
                            <p class="text-xs text-green-600 mt-1">Product ID: ${product.shopifyData.productId} ‚Ä¢ Variant ID: ${product.shopifyData.variantId}</p>
                            <p class="text-xs text-green-600">Status: ${product.shopifyData.status} ‚Ä¢ Handle: ${product.shopifyData.handle}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderPriceListProducts() {
            const searchQuery = elements.priceListSearch?.value.toLowerCase() || '';
            let filteredProducts = state.products;

            if (searchQuery) {
                filteredProducts = state.products.filter(product =>
                    product.model.toLowerCase().includes(searchQuery) ||
                    Object.values(product.specs).some(spec =>
                        spec.toString().toLowerCase().includes(searchQuery)
                    )
                );
            }

            elements.priceListProductCount.textContent = filteredProducts.length;

            if (filteredProducts.length > 0) {
                elements.priceListProducts.innerHTML = filteredProducts.map(createPriceListProductCard).join('');
                elements.emptyState.style.display = 'none';
                elements.exportSection.classList.remove('hidden');
            } else if (state.products.length > 0) {
                elements.priceListProducts.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500"><p>No products match your search</p></div>';
                elements.emptyState.style.display = 'none';
                elements.exportSection.classList.remove('hidden');
            } else {
                elements.priceListProducts.innerHTML = '';
                elements.emptyState.style.display = 'block';
                elements.exportSection.classList.add('hidden');
            }
        }

        // Event Handlers
        async function connectToShopify() {
            const store = elements.storeName.value.trim().replace(/\.myshopify\.com.*/, '');
            const token = elements.accessToken.value.trim();

            if (!store || !token) {
                alert('Please enter both store name and access token');
                return;
            }

            elements.connectBtn.disabled = true;
            document.getElementById('connectIcon').textContent = 'üîÑ';
            document.getElementById('connectText').textContent = 'Connecting...';

            try {
                console.log(`Testing connection to ${store}.myshopify.com...`);
                await shopifyAPI.testConnection(store, token);

                console.log('Connection successful, fetching data...');
                const [products, collections] = await Promise.all([
                    shopifyAPI.fetchProducts(store, token),
                    shopifyAPI.fetchCollections(store, token)
                ]);

                console.log(`Fetched ${products.length} products and ${collections.length} collections`);

                // Update state
                state.shopifyConnected = true;
                state.shopifyStore = store;
                state.shopifyToken = token;
                state.shopifyProducts = products;
                state.shopifyCollections = collections;

                // Extract unique types and vendors
                state.productTypes = [...new Set(products.map(p => p.product_type).filter(Boolean))];
                state.vendors = [...new Set(products.map(p => p.vendor).filter(Boolean))];

                // Update UI
                updateConnectionStatus(true, store);
                updateStats(products, collections, state.productTypes, state.vendors);
                populateFilters(collections, state.productTypes, state.vendors);
                renderShopifyProducts(products);

                // Switch to connected state
                elements.connectionForm.classList.add('hidden');
                elements.connectedState.classList.remove('hidden');
                document.getElementById('connectedStore').textContent = `${store}.myshopify.com`;

                // Update company info if default
                if (elements.companyName.value === 'Your Company Name') {
                    elements.companyName.value = store.charAt(0).toUpperCase() + store.slice(1).replace(/-/g, ' ');
                }

                alert(`Successfully connected to ${store}! Found ${products.length} products and ${collections.length} collections.`);

            } catch (error) {
                console.error('Shopify connection error:', error);
                alert(`Failed to connect to Shopify: ${error.message}\n\nPlease check:\n‚Ä¢ Store name is correct\n‚Ä¢ Access token is valid\n‚Ä¢ Token has required permissions`);
            } finally {
                elements.connectBtn.disabled = false;
                document.getElementById('connectIcon').textContent = 'üõçÔ∏è';
                document.getElementById('connectText').textContent = 'Connect to Shopify';
            }
        }

        function toggleProductSelection(productId) {
            const id = productId.toString();
            if (state.selectedProducts.includes(id)) {
                state.selectedProducts = state.selectedProducts.filter(p => p !== id);
            } else {
                state.selectedProducts.push(id);
            }
            
            updateSelectionUI();
            renderShopifyProducts(getFilteredProducts());
        }

        function addSelectedProducts() {
            const newProducts = [];

            state.selectedProducts.forEach(productId => {
                const shopifyProduct = state.shopifyProducts.find(p => p.id.toString() === productId);
                if (shopifyProduct) {
                    shopifyProduct.variants.forEach((variant, index) => {
                        newProducts.push(convertShopifyProduct(shopifyProduct, index));
                    });
                }
            });

            state.products = [...state.products, ...newProducts];
            state.selectedProducts = [];
            
            updateSelectionUI();
            renderPriceListProducts();
            alert(`Added ${newProducts.length} product(s) to your price list!`);
        }

        function addManualProduct() {
            const newProduct = {
                id: Date.now(),
                model: '',
                image: null,
                specs: {
                    sku: '',
                    type: '',
                    vendor: '',
                    description: ''
                },
                price: '',
                incVat: 'INCL VAT',
                productUrl: ''
            };

            state.products.push(newProduct);
            renderPriceListProducts();
        }

        function updateProduct(id, field, value) {
            state.products = state.products.map(product =>
                product.id.toString() === id.toString()
                    ? { ...product, [field]: value }
                    : product
            );
        }

        function updateProductSpec(id, spec, value) {
            state.products = state.products.map(product =>
                product.id.toString() === id.toString()
                    ? { ...product, specs: { ...product.specs, [spec]: value } }
                    : product
            );
        }

        function updateProductImage(id, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateProduct(id, 'image', e.target.result);
                    renderPriceListProducts();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeProduct(id) {
            if (confirm('Are you sure you want to remove this product?')) {
                state.products = state.products.filter(product => product.id.toString() !== id.toString());
                renderPriceListProducts();
            }
        }

        function duplicateProduct(id) {
            const productToDuplicate = state.products.find(p => p.id.toString() === id.toString());
            if (productToDuplicate) {
                const newProduct = {
                    ...productToDuplicate,
                    id: Date.now(),
                    model: productToDuplicate.model + ' (Copy)'
                };
                state.products.push(newProduct);
                renderPriceListProducts();
            }
        }

        function togglePreview() {
            state.showPreview = !state.showPreview;
            const previewSection = elements.previewSection;
            const previewBtn = elements.previewBtn;
            
            if (state.showPreview) {
                previewSection.classList.remove('hidden');
                document.getElementById('previewIcon').textContent = 'üôà';
                document.getElementById('previewText').textContent = 'Hide Preview';
                generatePreview();
            } else {
                previewSection.classList.add('hidden');
                document.getElementById('previewIcon').textContent = 'üëÅÔ∏è';
                document.getElementById('previewText').textContent = 'Show Preview';
            }
        }

        function generatePreview() {
            const companyInfo = {
                name: elements.companyName.value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                website: document.getElementById('companyWebsite').value,
                tagline: document.getElementById('companyTagline').value,
                terms: document.getElementById('companyTerms').value,
                logo: state.companyLogo
            };

            const listTitle = document.getElementById('listTitle').value;
            const bulletPoints = {
                point1: document.getElementById('bulletPoint1').value,
                point2: document.getElementById('bulletPoint2').value,
                point3: document.getElementById('bulletPoint3').value
            };

            const previewHTML = `
                <div class="bg-gradient-to-r from-gray-900 to-blue-900 text-white p-8">
                    <div class="flex flex-col lg:flex-row justify-between items-start gap-6">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-4">
                                ${companyInfo.logo ? `
                                    <div class="w-16 h-16 bg-white rounded-lg p-2 flex items-center justify-center">
                                        <img src="${companyInfo.logo}" alt="${companyInfo.name}" class="w-full h-full object-contain">
                                    </div>
                                ` : ''}
                                <h1 class="text-4xl lg:text-5xl font-bold">${companyInfo.name}</h1>
                            </div>
                            <div class="text-sm lg:text-base space-y-2">
                                <div>‚Ä¢ ${companyInfo.tagline}</div>
                                <div>‚Ä¢ Prices are subject to change without prior notice.</div>
                                <div>‚Ä¢ ${companyInfo.terms}</div>
                            </div>
                        </div>

                        <div class="w-full lg:w-auto text-center lg:text-right">
                            <div class="bg-blue-600 px-8 py-4 rounded-xl shadow-xl">
                                <h2 class="text-2xl lg:text-3xl font-bold">${listTitle}</h2>
                                <div class="text-sm lg:text-base mt-2">
                                    <div>‚Ä¢ ${bulletPoints.point1}</div>
                                    <div>‚Ä¢ ${bulletPoints.point2}</div>
                                    <div>‚Ä¢ ${bulletPoints.point3}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 lg:p-10">
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        ${state.products.map(product => `
                            <div class="preview-card">
                                <div class="flex flex-col sm:flex-row items-start gap-6">
                                    <div class="w-full sm:w-40 h-40 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border-2 border-gray-200 flex-shrink-0">
                                        ${product.image ? `
                                            <img src="${product.image}" alt="${product.model}" class="w-full h-full object-cover">
                                        ` : `
                                            <div class="text-gray-400 text-center">
                                                <div class="text-3xl mb-2">üì∑</div>
                                                <div>No Image</div>
                                            </div>
                                        `}
                                    </div>
                                    
                                    <div class="flex-1 min-w-0 w-full">
                                        <h3 class="font-bold text-xl text-gray-900 mb-4">${product.model || 'Product Model'}</h3>
                                        
                                        <div class="space-y-2 text-sm">
                                            ${Object.entries(product.specs).map(([key, value]) => {
                                                if (!value) return '';
                                                const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                                                return `
                                                    <div class="flex flex-wrap">
                                                        <span class="text-gray-600 font-medium">‚Ä¢ ${label}:</span>
                                                        <span class="ml-2 font-semibold text-gray-800">${value}</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="w-full sm:w-auto text-center sm:text-right flex-shrink-0">
                                        <div class="flex flex-col items-center sm:items-end gap-3">
                                            <div class="price-badge text-white px-6 py-3 rounded-xl shadow-lg">
                                                <div class="text-2xl font-bold">${product.price || 'R 0.00'}</div>
                                                ${product.comparePrice ? `<div class="text-xs text-red-400 line-through">${product.comparePrice}</div>` : ''}
                                                <div class="text-xs text-red-400 font-bold mt-1">${product.incVat}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-gray-900 text-white p-6 lg:p-8 mt-8">
                    <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div class="space-y-2 text-center lg:text-left">
                            <div class="flex items-center justify-center lg:justify-start gap-3">
                                <span class="text-xl">üìû</span>
                                <span class="text-lg">${companyInfo.phone}</span>
                            </div>
                            <div class="flex items-center justify-center lg:justify-start gap-3">
                                <span class="text-xl">‚úâÔ∏è</span>
                                <span class="text-lg">${companyInfo.email}</span>
                            </div>
                            <div class="flex items-center justify-center lg:justify-start gap-3">
                                <span class="text-xl">üåê</span>
                                <span class="text-lg">${companyInfo.website}</span>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-sm mb-3">Scan to visit our website:</div>
                            <div class="w-24 h-24 bg-white rounded-lg mx-auto flex items-center justify-center shadow-lg p-2">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(companyInfo.website)}" alt="QR Code" class="w-full h-full">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('previewContent').innerHTML = previewHTML;
        }

        function exportToPDF() {
            if (state.products.length === 0) {
                alert('Please add some products before exporting.');
                return;
            }

            generatePreview();

            const printWindow = window.open('', '_blank');
            const previewContent = document.getElementById('previewContent').outerHTML;

            const printDocument = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Price List - ${elements.companyName.value}</title>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <script src="https://cdn.tailwindcss.com"></script>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.5; color: #111827; background: white; }
                            @media print { 
                                @page { margin: 0.5in; size: A4; } 
                                body { -webkit-print-color-adjust: exact; color-adjust: exact; print-color-adjust: exact; } 
                            }
                            .preview-card {
                                background: white;
                                border: 2px solid #e5e7eb;
                                border-radius: 0.75rem;
                                padding: 1.5rem;
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                            }
                            .price-badge {
                                background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
                            }
                        </style>
                    </head>
                    <body>
                        ${previewContent}
                        <script>
                            window.onload = function() {
                                setTimeout(function() {
                                    window.print();
                                    window.onafterprint = function() {
                                        window.close();
                                    };
                                }, 500);
                            };
                        </script>
                    </body>
                </html>
            `;

            printWindow.document.write(printDocument);
            printWindow.document.close();
        }

        // Event Listeners
        elements.shopifyPanelBtn.addEventListener('click', () => {
            elements.shopifyPanel.classList.toggle('hidden');
        });

        elements.connectBtn.addEventListener('click', connectToShopify);

        elements.cancelBtn.addEventListener('click', () => {
            elements.shopifyPanel.classList.add('hidden');
        });

        elements.disconnectBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to disconnect from Shopify?')) {
                state.shopifyConnected = false;
                state.shopifyProducts = [];
                state.shopifyCollections = [];
                state.productTypes = [];
                state.vendors = [];
                state.selectedProducts = [];
                
                updateConnectionStatus(false);
                elements.connectionForm.classList.remove('hidden');
                elements.connectedState.classList.add('hidden');
                elements.storeName.value = '';
                elements.accessToken.value = '';
            }
        });

        elements.refreshBtn.addEventListener('click', async () => {
            if (!state.shopifyConnected) return;

            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.textContent = 'üîÑ';
            
            try {
                const [products, collections] = await Promise.all([
                    shopifyAPI.fetchProducts(state.shopifyStore, state.shopifyToken),
                    shopifyAPI.fetchCollections(state.shopifyStore, state.shopifyToken)
                ]);

                state.shopifyProducts = products;
                state.shopifyCollections = collections;
                state.productTypes = [...new Set(products.map(p => p.product_type).filter(Boolean))];
                state.vendors = [...new Set(products.map(p => p.vendor).filter(Boolean))];

                updateStats(products, collections, state.productTypes, state.vendors);
                populateFilters(collections, state.productTypes, state.vendors);
                renderShopifyProducts(getFilteredProducts());

                alert('Shopify data refreshed successfully!');
            } catch (error) {
                console.error('Error refreshing Shopify data:', error);
                alert(`Error refreshing data: ${error.message}`);
            } finally {
                refreshIcon.textContent = 'üîÑ';
            }
        });

        elements.filterMode.addEventListener('change', (e) => {
            const mode = e.target.value;
            
            // Hide all filter options
            elements.collectionFilter.classList.add('hidden');
            elements.typeFilter.classList.add('hidden');
            elements.vendorFilter.classList.add('hidden');
            elements.customFilters.classList.add('hidden');
            
            // Show relevant filter
            switch (mode) {
                case 'collection':
                    elements.collectionFilter.classList.remove('hidden');
                    break;
                case 'type':
                    elements.typeFilter.classList.remove('hidden');
                    break;
                case 'vendor':
                    elements.vendorFilter.classList.remove('hidden');
                    break;
                case 'custom':
                    elements.customFilters.classList.remove('hidden');
                    break;
            }
            
            renderShopifyProducts(getFilteredProducts());
        });

        elements.productSearch.addEventListener('input', () => {
            renderShopifyProducts(getFilteredProducts());
        });

        document.getElementById('selectedCollection').addEventListener('change', () => {
            renderShopifyProducts(getFilteredProducts());
        });

        document.getElementById('selectedType').addEventListener('change', () => {
            renderShopifyProducts(getFilteredProducts());
        });

        document.getElementById('selectedVendor').addEventListener('change', () => {
            renderShopifyProducts(getFilteredProducts());
        });

        document.getElementById('priceMin').addEventListener('input', () => {
            renderShopifyProducts(getFilteredProducts());
        });

        document.getElementById('priceMax').addEventListener('input', () => {
            renderShopifyProducts(getFilteredProducts());
        });

        elements.selectAllBtn.addEventListener('click', () => {
            const filteredProducts = getFilteredProducts();
            state.selectedProducts = filteredProducts.map(p => p.id.toString());
            updateSelectionUI();
            renderShopifyProducts(filteredProducts);
        });

        elements.clearSelectionBtn.addEventListener('click', () => {
            state.selectedProducts = [];
            updateSelectionUI();
            renderShopifyProducts(getFilteredProducts());
        });

        elements.addSelectedBtn.addEventListener('click', addSelectedProducts);

        elements.addManualBtn.addEventListener('click', addManualProduct);

        document.getElementById('emptyConnectBtn').addEventListener('click', () => {
            elements.shopifyPanel.classList.remove('hidden');
        });

        document.getElementById('emptyManualBtn').addEventListener('click', addManualProduct);

        elements.logoUploadBtn.addEventListener('click', () => {
            elements.logoInput.click();
        });

        elements.logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.companyLogo = e.target.result;
                    elements.logoPreview.innerHTML = `
                        <img src="${e.target.result}" alt="Company logo" class="w-full h-full object-contain">
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        elements.previewBtn.addEventListener('click', togglePreview);

        document.getElementById('exportBtn').addEventListener('click', exportToPDF);

        document.getElementById('priceListSearch').addEventListener('input', renderPriceListProducts);

        document.getElementById('viewModeGrid').addEventListener('click', () => {
            state.viewMode = 'grid';
            document.getElementById('viewModeGrid').className = 'p-3 rounded-lg transition-colors bg-blue-600 text-white';
            document.getElementById('viewModeList').className = 'p-3 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
            elements.priceListProducts.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';
        });

        document.getElementById('viewModeList').addEventListener('click', () => {
            state.viewMode = 'list';
            document.getElementById('viewModeList').className = 'p-3 rounded-lg transition-colors bg-blue-600 text-white';
            document.getElementById('viewModeGrid').className = 'p-3 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
            elements.priceListProducts.className = 'space-y-4';
        });

        // Global functions for inline event handlers
        window.toggleProductSelection = toggleProductSelection;
        window.updateProduct = updateProduct;
        window.updateProductSpec = updateProductSpec;
        window.updateProductImage = updateProductImage;
        window.removeProduct = removeProduct;
        window.duplicateProduct = duplicateProduct;

        // Initialize the application
        console.log('üöÄ Shopify Price List Generator initialized');
        renderPriceListProducts();

        // Update filtered count initially
        const updateFilteredCount = () => {
            const filteredProducts = getFilteredProducts();
            document.getElementById('filteredCount').textContent = filteredProducts.length;
        };

        // Update filtered count when filter changes
        elements.filterMode.addEventListener('change', updateFilteredCount);
        elements.productSearch.addEventListener('input', updateFilteredCount);
        
        // Initial update
        updateFilteredCount();

    </script>
</body>
</html>